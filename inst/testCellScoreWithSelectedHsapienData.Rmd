---
title: "testCellScoreWithSelectedHsapienData"
author: "Siyuan"
date: "6/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
getCellTypeMap <- function() {
    ## Hardcode abbreviations for each cell type
    cellTypes <- c(
        "RPE",
        "ESC",
        "ESC.d",
        "ESC.t",
        "iPS",  ## check the comment
        "IPS",
        "URI",
        "PBMC",
        "HUVEC",

        "derived cardiomyocyte",
        "hepatocyte-like cell",
        "hepatocyte",
        "fetal liver",
        "derived dopaminergic neuron",
        "derived neuron",
        "spinal cord",
        "derived neural progenitor cell",
        "derived RPE",
        "fetal RPE",
        "fetal heart",
        "derived neural stem cell",
        "naive IPS",
        "naive ESC",
        "fetal brain",
        "derived pancreatic b-like cell",
        "derived endoderm",
        "derived foregut endoderm",
        "derived hepatic endoderm",
        "derived early hepatocyte",
        "derived late hepatocyte",
        "fibroblast",
        "induced neuron",
        "fibroblast.treated",
        "cardiomyocytes",
        "hepatocytes",
        "dopaminergic neurons",
        "neurons",
        "neual progenitor cell",
        "neural stem cells",
        "pancreatic beta cell",
        "endoderm",
        "foregut endoderm",
        "hepatic endoderm",
        "neuron",
        "lymphocyte")

    abbrv <- c(
        ## Original abbreviations
        "RPE",
        "ESC",
        "ESC.d",
        "ESC.t",
        "IPS",
        "IPS",
        "URI",
        "PBMC",
        "HUVEC",
        ## Abbreviations named by me
        "dCDM",
        "HPTL",
        "HPT",
        "fLIV",
        "dDPNEU",
        "dNEU",
        "SPC",
        "dNEUPR",
        "dRPE",
        "fRPE",
        "fHRT",
        "dNEUST",
        "nIPS",
        "nESC",
        "fBRN",
        "dPCB",
        "dEDD",
        "dFEDD",
        "dHPTEDD",
        "dEHPT",
        "dLHPT",
        "FIB",
        "INEU",
        "FIB.t",
        "CDM",
        "HPT",
        "DPNEU",
        "NEU",
        "NEUPR",
        "NEUST",
        "PCB",
        "EDD",
        "FEDD",
        "HPTEDD",
        "NEU",
        "LPC")

    cellTypeMap <- setNames(abbrv, cellTypes)
    print(cellTypeMap)
    cellTypeMap
}
```

```{r}
prepareSampleTransitions <- function() {

    dat <- read.csv(system.file("extdata",
                                  "sampleMetadata.csv",
                                  package = "CellScore"),
                    header = TRUE)

    uniqueCellTypes <- unique(c(as.array(dat$general_cell_type),
                                as.array(dat$target_cell_type),
                                as.array(dat$parental_cell_type)))

    print(uniqueCellTypes)

    cellTypeMap <- getCellTypeMap()

    uniqueTransitions <- unique(dat[dat$category == 'test',
                                    c('parental_cell_type',
                                      'general_cell_type',
                                      'target_cell_type')])

    colnames(uniqueTransitions) <- c("start",	"test", "target")

    ## Exclude samples without parental cell types or without target cell type
    uniqueTransitions <- uniqueTransitions[!is.na(uniqueTransitions$start) &
                                             !is.na(uniqueTransitions$target) &
                                             uniqueTransitions$start != '' &
                                             uniqueTransitions$target != '', ]

    ## Replace full cell type names with abbreviations
    uniqueTransitionsAbbrv <- as.data.frame(lapply(uniqueTransitions,
                                                   function(element) {
                                                      (cellTypeMap[element])
                                                   }))


    tempDirPath <- paste(getwd(), 'temp', sep = '/')
    dir.create(tempDirPath)

    write.table(uniqueTransitionsAbbrv,
                file = paste(getwd(),
                             'temp',
                             'exampleTransitionsHsapienData.tsv',
                             sep = '/'),
                quote = FALSE,
                sep = '\t')

    uniqueTransitionsAbbrv
}
```

```{r}
library(SummarizedExperiment)

prepareSampleTransitions()
CellTypeMap <- getCellTypeMap()

rdata.path <- system.file("extdata", "dee2DataDeseq2Normalized",
  package="CellScore")
tsvdata.path <- system.file("extdata", "exampleTransitionsHsapienData.tsv",
  package="CellScore")

 
if (file.exists(rdata.path) && file.exists(tsvdata.path)) {
  dee2DataDeseq2Normalized <- readRDS(rdata.path)
  normalizedSExpr <- dee2DataDeseq2Normalized$normalizedSExpr
  
  colData(normalizedSExpr)[, 'general_cell_type'] <- unname(as.array(sapply(
    normalizedSExpr$general_cell_type, 
    function(element) CellTypeMap[[element]], USE.NAMES = FALSE)))
  
  colData(normalizedSExpr)[, 'parental_cell_type'] <- unname(as.array(sapply(
    normalizedSExpr$parental_cell_type, 
    function(element) {
      if (is.na(element)) {
        return(NA)
      }
      CellTypeMap[[element]]
    }, USE.NAMES = FALSE)))
  
  colData(normalizedSExpr)$sub_cell_type1 <- paste(
    colData(normalizedSExpr)$general_cell_type, 
    colData(normalizedSExpr)$parental_cell_type,
    sep = '-')

    
  
  cell.change <- read.delim(
    file=tsvdata.path, 
    sep="\t",
    header=TRUE, 
    stringsAsFactors=FALSE)
  print("Content of cell.change")
  print(cell.change)
  
  print("'normalizedSExpr' returns")
  print(normalizedSExpr)
}

```
```{r}
group.OnOff <- OnOff(normalizedSExpr, cell.change, out.put="marker.list")
print(group.OnOff)
print(summary(group.OnOff))
```

