---
title: "test CellScore With SelectedHsapienData normalized with Deseq2 normalization"
author: "Siyuan"
date: "6/29/2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Data preprocessing

#### creating a map between cell types and their abbreviations
Function 'getCellTypeMap' in this example returns a map between cell types and their abbreviations.
This map is not part of the CellScore library and should be defined by the user. Each abbreviation should 
be unique and has a 1-to-1 mapping to a cell type.
```{r}
getCellTypeMap <- function() {
    ## Hardcode abbreviations for each cell type
    cellTypes <- c(
        "RPE",
        "ESC",
        "ESC.d",
        "ESC.t",
        "iPS",  ## check the comment
        "IPS",
        "URI",
        "PBMC",
        "HUVEC",

        "derived cardiomyocyte",
        "hepatocyte-like cell",
        "hepatocyte",
        "fetal liver",
        "derived dopaminergic neuron",
        "derived neuron",
        "spinal cord",
        "derived neural progenitor cell",
        "derived RPE",
        "fetal RPE",
        "fetal heart",
        "derived neural stem cell",
        "naive IPS",
        "naive ESC",
        "fetal brain",
        "derived pancreatic b-like cell",
        "derived endoderm",
        "derived foregut endoderm",
        "derived hepatic endoderm",
        "derived early hepatocyte",
        "derived late hepatocyte",
        "fibroblast",
        "induced neuron",
        "fibroblast.treated",
        "cardiomyocytes",
        "hepatocytes",
        "dopaminergic neurons",
        "neurons",
        "neual progenitor cell",
        "neural stem cells",
        "pancreatic beta cell",
        "endoderm",
        "foregut endoderm",
        "hepatic endoderm",
        "neuron",
        "lymphocyte")

    abbrv <- c(
        ## Original abbreviations
        "RPE",
        "ESC",
        "ESC.d",
        "ESC.t",
        "IPS",
        "IPS",
        "URI",
        "PBMC",
        "HUVEC",
        ## Abbreviations named by me
        "dCDM",
        "HPTL",
        "HPT",
        "fLIV",
        "dDPNEU",
        "dNEU",
        "SPC",
        "dNEUPR",
        "dRPE",
        "fRPE",
        "fHRT",
        "dNEUST",
        "nIPS",
        "nESC",
        "fBRN",
        "dPCB",
        "dEDD",
        "dFEDD",
        "dHPTEDD",
        "dEHPT",
        "dLHPT",
        "FIB",
        "INEU",
        "FIB.t",
        "CDM",
        "HPT",
        "DPNEU",
        "NEU",
        "NEUPR",
        "NEUST",
        "PCB",
        "EDD",
        "FEDD",
        "HPTEDD",
        "NEU",
        "LPC")

    cellTypeMap <- setNames(abbrv, cellTypes)
    
    # Mapping from full cell type names to their abbrvs
    print(cellTypeMap)
    cellTypeMap
}
```
#### Prepare 'cell.change' data frame
 The following code prepares 'cell.change' data frame. This data frame contains 3 columns, 
 which are 'start', 'test' and 'target'. Each row in the data frame represents the transition 
 in an experiment. The values in the 'start' column are the abbreviations of
 parental cell types (or starting cell types) in the transitions. The values in 'target' column are the abbreviations of
 the target cell types in the transitions. The values in 'test' column are in the format '{test_cell_type}-{start}', where
 '{test_cell_type}' are the abbreviations of the name assigned to the test cells and '{start}' are the abbreviations of
 parental cell types (or starting cell types). The following function 'prepareSampleTransitions' is used to generate and save the 'cell.change' in a
 tsv file and is not part of 'CellScore' library. The user should create this data frame based on the experiment data.
 

```{r}
prepareSampleTransitions <- function() {

    dat <- read.csv(system.file("extdata",
                                  "sampleMetadata.csv",
                                  package = "CellScore"),
                    header = TRUE)

    uniqueCellTypes <- unique(c(as.array(dat$general_cell_type),
                                as.array(dat$target_cell_type),
                                as.array(dat$parental_cell_type)))
    
    # Show all the unique cell types in the data
    print(uniqueCellTypes)

    cellTypeMap <- getCellTypeMap()

    uniqueTransitions <- unique(dat[dat$category == 'test',
                                    c('parental_cell_type',
                                      'general_cell_type',
                                      'target_cell_type')])

    colnames(uniqueTransitions) <- c("start",	"test", "target")

    ## Exclude samples without parental cell types or without target cell type
    uniqueTransitions <- uniqueTransitions[!is.na(uniqueTransitions$start) &
                                             !is.na(uniqueTransitions$target) &
                                             uniqueTransitions$start != '' &
                                             uniqueTransitions$target != '', ]

    ## Replace full cell type names with abbreviations
    uniqueTransitionsAbbrv <- as.data.frame(lapply(uniqueTransitions,
                                                   function(element) {
                                                      (cellTypeMap[element])
                                                   }))

    
    ## Format 'test' column
    uniqueTransitionsAbbrv$test <- paste(uniqueTransitionsAbbrv$test,
                                         uniqueTransitionsAbbrv$start,
                                         sep = '-')

    tempDirPath <- paste(getwd(), 'temp', sep = '/')
    dir.create(tempDirPath)

    write.table(uniqueTransitionsAbbrv,
                file = system.file("extdata", "exampleTransitionsHsapienData.tsv",
                                   package="CellScore"),
                quote = FALSE,
                sep = '\t')

    uniqueTransitionsAbbrv
}
```

### Calculate 'CellScore'
#### Generate 'OnOff' score by run 'OnOff' function with 'cell.change' data frame and experiment data.
 'CellScore' library analyze the 'CellScore' of test cells with given standard cells in the experiment data. The 'category' of test cells and standard cells
 are 'test' and 'standard' respectively. Transitions with insufficient standard cell types (at least 3 for both 'start' and 'target') would be ignored by 'CellScore' library.
```{r}
library(SummarizedExperiment)
library(CellScore)
library(DEE2HsapienData)

prepareSampleTransitions()
CellTypeMap <- getCellTypeMap()

rdata.path <- system.file("extdata", "deseq2NormalizedDee2Data",
  package="CellScore")
tsvdata.path <- system.file("extdata", "exampleTransitionsHsapienData.tsv",
  package="CellScore")

 
if (file.exists(rdata.path) && file.exists(tsvdata.path)) {
  deseq2NormalizedDee2Data <- readRDS(rdata.path)
  normalizedSExpr <- deseq2NormalizedDee2Data$normalizedSExpr
  
  # replace values in 'general_cell_type' with abbrvs 
  colData(normalizedSExpr)[, 'general_cell_type'] <- unname(as.array(sapply(
    normalizedSExpr$general_cell_type, 
    function(element) CellTypeMap[[element]], USE.NAMES = FALSE)))
  
  # replace values in 'parental_cell_type' with abbrvs
  colData(normalizedSExpr)[, 'parental_cell_type'] <- unname(as.array(sapply(
    normalizedSExpr$parental_cell_type, 
    function(element) {
      if (is.na(element)) {
        return(NA)
      }
      CellTypeMap[[element]]
    }, USE.NAMES = FALSE)))
  
  # set values of 'sub_cell_type1' column
  colData(normalizedSExpr)$sub_cell_type1 <- paste(
    colData(normalizedSExpr)$general_cell_type, 
    colData(normalizedSExpr)$parental_cell_type,
    sep = '-')

  pcaPlot(normalizedSExpr)
  
  
  cell.change <- read.delim(
    file=tsvdata.path, 
    sep="\t",
    header=TRUE, 
    stringsAsFactors=FALSE)
  
  print("Content of cell.change")
  print(cell.change)
  
  print("'normalizedSExpr' returns")
  print(normalizedSExpr)
}

```

Calculate 'OnOff' scores
```{r}
group.OnOff <- OnOff(normalizedSExpr, cell.change, out.put="marker.list")
print(summary(group.OnOff))
```

```{r}
individ.OnOff <- OnOff(normalizedSExpr, cell.change, out.put="individual")
```

```{r}
barplot.out <- BarplotOnOff(normalizedSExpr, group.OnOff$scores)
barplot.out
```

```{r}
tmp.time <- system.time(cs <- CosineSimScore(normalizedSExpr, cell.change,
                                             iqr.cutoff=0.1))
PlotCosineSimHeatmap(cs$cosine.general.groups, "general groups",
                     width=20, height=20, x=-20, y=3)

```

```{r}
cellscore <- CellScore(normalizedSExpr, cell.change, individ.OnOff$scores,
                       cs$cosine.samples)

```

```{r}
ScatterplotCellScoreComponents(cellscore, cell.change, FALSE)

```

```{r}
pdf(file="CellScoreReport_PerTransition.pdf", width=7, height=11)
CellScoreReport(cellscore, cell.change, group.OnOff$markers, normalizedSExpr)

```
